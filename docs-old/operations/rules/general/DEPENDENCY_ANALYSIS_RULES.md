# ПРАВИЛА АНАЛИЗА ЗАВИСИМОСТЕЙ ТАБЛИЦ

## Описание
Данный модуль обеспечивает анализ зависимостей между таблицами, проверку готовности ссылочных таблиц и определение оптимального порядка миграции с учётом внешних ключей.

## Основные функции

### 1. Анализ внешних ключей
- Определение всех внешних ключей для каждой таблицы
- Анализ ссылочных таблиц и столбцов
- Классификация типов зависимостей

### 2. Проверка готовности ссылочных таблиц
- Валидация существования ссылочных таблиц в PostgreSQL
- Проверка готовности структуры ссылочных таблиц
- Анализ целостности данных в ссылочных таблицах

### 3. Выявление циклических зависимостей
- Обнаружение циклических ссылок между таблицами
- Анализ сложных зависимостей
- Предложение стратегий разрешения циклов

### 4. Определение порядка миграции
- Построение графа зависимостей
- Топологическая сортировка таблиц
- Оптимизация порядка миграции

## Типы зависимостей

### Простые зависимости
- **Прямая зависимость** - таблица A ссылается на таблицу B
- **Обратная зависимость** - таблица B зависит от таблицы A
- **Транзитивная зависимость** - A → B → C

### Сложные зависимости
- **Циклические зависимости** - A → B → A
- **Множественные зависимости** - A зависит от B и C
- **Каскадные зависимости** - A → B → C → D

### Критические зависимости
- **Критические ссылки** - обязательные внешние ключи
- **Опциональные ссылки** - nullable внешние ключи
- **Каскадные операции** - CASCADE, SET NULL, RESTRICT

## Python API

### Основные функции

#### `analyze_table_dependencies(table_name)`
```python
def analyze_table_dependencies(table_name):
    """
    Анализ зависимостей для конкретной таблицы
    
    Args:
        table_name (str): Имя таблицы для анализа
    
    Returns:
        dict: Информация о зависимостях таблицы
    """
```

#### `check_referenced_tables_ready(table_name)`
```python
def check_referenced_tables_ready(table_name):
    """
    Проверка готовности ссылочных таблиц
    
    Args:
        table_name (str): Имя таблицы для проверки
    
    Returns:
        dict: Статус готовности ссылочных таблиц
    """
```

#### `detect_circular_dependencies()`
```python
def detect_circular_dependencies():
    """
    Выявление циклических зависимостей
    
    Returns:
        list: Список циклических зависимостей
    """
```

#### `get_migration_order()`
```python
def get_migration_order():
    """
    Определение оптимального порядка миграции
    
    Returns:
        list: Список таблиц в порядке миграции
    """
```

### Дополнительные функции

#### `get_dependency_graph()`
```python
def get_dependency_graph():
    """
    Получение графа зависимостей
    
    Returns:
        dict: Граф зависимостей в формате adjacency list
    """
```

#### `analyze_dependency_chain(table_name)`
```python
def analyze_dependency_chain(table_name):
    """
    Анализ цепочки зависимостей для таблицы
    
    Args:
        table_name (str): Имя таблицы
    
    Returns:
        list: Цепочка зависимостей
    """
```

#### `get_critical_dependencies()`
```python
def get_critical_dependencies():
    """
    Получение критических зависимостей
    
    Returns:
        list: Список критических зависимостей
    """
```

#### `validate_dependency_integrity(table_name)`
```python
def validate_dependency_integrity(table_name):
    """
    Валидация целостности зависимостей
    
    Args:
        table_name (str): Имя таблицы
    
    Returns:
        bool: True если зависимости корректны
    """
```

## Структура данных

### Таблица зависимостей
```sql
CREATE TABLE mcl.table_dependencies (
    id SERIAL PRIMARY KEY,
    source_table_name VARCHAR(255) NOT NULL,
    target_table_name VARCHAR(255) NOT NULL,
    dependency_type VARCHAR(50) NOT NULL,
    is_critical BOOLEAN DEFAULT FALSE,
    is_circular BOOLEAN DEFAULT FALSE,
    dependency_level INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(source_table_name, target_table_name)
);
```

### Таблица готовности ссылочных таблиц
```sql
CREATE TABLE mcl.referenced_table_readiness (
    id SERIAL PRIMARY KEY,
    table_name VARCHAR(255) NOT NULL,
    referenced_table_name VARCHAR(255) NOT NULL,
    is_ready BOOLEAN DEFAULT FALSE,
    readiness_reason TEXT,
    checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(table_name, referenced_table_name)
);
```

### Индексы
```sql
CREATE INDEX idx_table_dependencies_source ON mcl.table_dependencies(source_table_name);
CREATE INDEX idx_table_dependencies_target ON mcl.table_dependencies(target_table_name);
CREATE INDEX idx_table_dependencies_type ON mcl.table_dependencies(dependency_type);
CREATE INDEX idx_referenced_readiness_table ON mcl.referenced_table_readiness(table_name);
```

## Алгоритмы анализа

### 1. Построение графа зависимостей
```python
def build_dependency_graph():
    """
    Построение графа зависимостей из метаданных
    """
    # Получение всех внешних ключей
    # Построение adjacency list
    # Классификация типов зависимостей
```

### 2. Топологическая сортировка
```python
def topological_sort(graph):
    """
    Топологическая сортировка для определения порядка миграции
    """
    # Алгоритм Kahn's algorithm
    # Обработка циклических зависимостей
    # Возврат оптимального порядка
```

### 3. Обнаружение циклов
```python
def detect_cycles(graph):
    """
    Обнаружение циклических зависимостей
    """
    # DFS с отслеживанием цвета вершин
    # Обнаружение back edges
    # Классификация типов циклов
```

### 4. Анализ готовности
```python
def analyze_readiness(table_name):
    """
    Анализ готовности таблицы к миграции
    """
    # Проверка существования ссылочных таблиц
    # Валидация структуры
    # Проверка данных
```

## Классификация зависимостей

### По типу связи
- **One-to-One** - уникальная связь
- **One-to-Many** - обычная связь
- **Many-to-Many** - через промежуточную таблицу

### По критичности
- **Критические** - обязательные для работы
- **Опциональные** - могут быть отложены
- **Каскадные** - влияют на другие таблицы

### По сложности
- **Простые** - прямая зависимость
- **Сложные** - множественные зависимости
- **Циклические** - взаимные зависимости

## Стратегии разрешения зависимостей

### Для простых зависимостей
1. **Последовательная миграция** - по порядку зависимостей
2. **Параллельная миграция** - независимые таблицы одновременно
3. **Пакетная миграция** - группы связанных таблиц

### Для циклических зависимостей
1. **Временное отключение внешних ключей**
2. **Миграция без внешних ключей с последующим созданием**
3. **Разбиение цикла на этапы**

### Для критических зависимостей
1. **Приоритетная миграция** - сначала критические таблицы
2. **Валидация целостности** - проверка после каждого этапа
3. **Откат при ошибках** - восстановление предыдущего состояния

## Интеграция с другими модулями

### С модулем управления списком таблиц
- Получение списка таблиц для анализа
- Обновление статуса готовности
- Передача информации о зависимостях

### С модулем переноса данных
- Определение порядка переноса
- Проверка готовности перед переносом
- Валидация целостности после переноса

### С модулем мониторинга
- Логирование анализа зависимостей
- Отслеживание сложных зависимостей
- Уведомления о проблемах

## Обработка ошибок

### Типы ошибок зависимостей
1. **Отсутствующие ссылочные таблицы**
2. **Некорректные ссылки**
3. **Циклические зависимости**
4. **Нарушение целостности**

### Стратегии восстановления
1. **Автоматическое разрешение** - для простых случаев
2. **Ручное вмешательство** - для сложных зависимостей
3. **Отложенная обработка** - для циклических зависимостей
4. **Альтернативные стратегии** - для критических случаев

## Примеры использования

### Анализ зависимостей таблицы
```python
# Анализ зависимостей для таблицы
dependencies = analyze_table_dependencies('orders')
print(f"Таблица orders зависит от: {dependencies['referenced_tables']}")
print(f"Критические зависимости: {dependencies['critical_dependencies']}")

# Проверка готовности
readiness = check_referenced_tables_ready('orders')
print(f"Готовность ссылочных таблиц: {readiness['ready_percentage']}%")
```

### Определение порядка миграции
```python
# Получение оптимального порядка
migration_order = get_migration_order()
print("Порядок миграции:")
for i, table in enumerate(migration_order, 1):
    print(f"{i}. {table}")

# Анализ циклических зависимостей
cycles = detect_circular_dependencies()
if cycles:
    print(f"Обнаружены циклические зависимости: {cycles}")
```

### Валидация целостности
```python
# Валидация зависимостей
is_valid = validate_dependency_integrity('orders')
if not is_valid:
    print("Обнаружены проблемы с зависимостями")
    
# Получение критических зависимостей
critical = get_critical_dependencies()
print(f"Критические зависимости: {len(critical)}")
```

## Метрики и мониторинг

### Метрики зависимостей
- **Количество зависимостей** - общее число связей
- **Глубина зависимостей** - максимальная глубина цепочки
- **Циклические зависимости** - количество циклов
- **Критические зависимости** - количество критических связей

### Статистика готовности
- **Процент готовности** - доля готовых таблиц
- **Время анализа** - время выполнения анализа
- **Сложность зависимостей** - оценка сложности

## Следующие шаги

1. **Реализация Python функций**
2. **Создание тестового скрипта**
3. **Интеграция с модулем управления списком**
4. **Тестирование на реальных зависимостях**
5. **Оптимизация алгоритмов анализа**