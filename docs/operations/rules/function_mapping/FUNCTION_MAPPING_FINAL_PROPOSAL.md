# üéØ –§–ò–ù–ê–õ–¨–ù–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ü–û –°–ò–°–¢–ï–ú–ï –ú–ê–ü–ü–ò–ù–ì–ê –§–£–ù–ö–¶–ò–ô

## üéØ –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ —Å–∏—Å—Ç–µ–º–µ –º–∞–ø–ø–∏–Ω–≥–∞ —Ñ—É–Ω–∫—Ü–∏–π MS SQL Server –≤ PostgreSQL –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º.

---

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–û–í–û–ô –ú–ò–ì–†–ê–¶–ò–ò

### ‚úÖ **–£–°–ü–ï–®–ù–û –í–´–ü–û–õ–ù–ï–ù–û:**
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü:** 166 —Ç–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞–Ω—ã –≤ —Å—Ö–µ–º–µ `ags`
- **–ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö:** 385,841 —Å—Ç—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã
- **–ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:** 69 —Ç–∞–±–ª–∏—Ü –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ 100%
- **–¢–∞–±–ª–∏—Ü—ã —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏:** 20 —Ç–∞–±–ª–∏—Ü –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ 100%

### üö® **–í–´–Ø–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:**

#### **1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –º–∞–ø–ø–∏–Ω–≥–æ–º —Ñ—É–Ω–∫—Ü–∏–π:**
- **–¢–∞–±–ª–∏—Ü —Å –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏:** 32
- **–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω—ã:** 2 –∏–∑ 32 (6.3%)
- **–û—à–∏–±–∫–∏ –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è—Ö:** 30 –∏–∑ 32 (93.7%)

#### **2. –¢–∏–ø—ã –æ—à–∏–±–æ–∫ –≤ `postgres_computed_definition`:**
```
‚ùå –û—à–∏–±–∫–∞: —Å—Ç–æ–ª–±–µ—Ü "cn_key" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
‚ùå –û—à–∏–±–∫–∞: –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: " ")
‚ùå –û—à–∏–±–∫–∞: –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: "[")
‚ùå –û—à–∏–±–∫–∞: –æ—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ: "CAST( AS )")
```

#### **3. –ü—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–æ–∫:**
- **–ù–µ–∑–∞–º–∞–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ MS SQL:** `[column]`, `CAST( AS )`, `case when`
- **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PostgreSQL:** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MS SQL —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:** –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å

---

## üöÄ –§–ò–ù–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ú–ê–ü–ü–ò–ù–ì–ê

### **üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –†–ï–®–ï–ù–ò–Ø**

#### **1. –°–ø—Ä–∞–≤–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞**

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞ —Ñ—É–Ω–∫—Ü–∏–π
CREATE TABLE mcl.function_mapping_rules (
    id SERIAL PRIMARY KEY,
    source_function VARCHAR NOT NULL,
    target_function VARCHAR NOT NULL,
    mapping_pattern TEXT NOT NULL, -- —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
    replacement_pattern TEXT NOT NULL, -- —Å—Ç—Ä–æ–∫–∞ –∑–∞–º–µ–Ω—ã
    mapping_type VARCHAR NOT NULL, -- direct, regex, custom
    complexity_level INTEGER DEFAULT 1, -- 1=simple, 2=complex, 3=custom
    applicable_objects TEXT[], -- 'default_constraint', 'computed_column', 'check_constraint', 'index'
    description TEXT,
    examples TEXT[],
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_function_mapping_rules_source ON mcl.function_mapping_rules(source_function);
CREATE INDEX idx_function_mapping_rules_type ON mcl.function_mapping_rules(mapping_type);
CREATE INDEX idx_function_mapping_rules_active ON mcl.function_mapping_rules(is_active);
CREATE INDEX idx_function_mapping_rules_objects ON mcl.function_mapping_rules USING GIN(applicable_objects);
```

#### **2. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã postgres_columns**

```sql
-- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã postgres_columns –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞
ALTER TABLE mcl.postgres_columns
ADD COLUMN computed_function_mapping_rule_id INTEGER,
ADD COLUMN computed_mapping_status VARCHAR DEFAULT 'pending', -- pending, mapped, error
ADD COLUMN computed_mapping_complexity VARCHAR DEFAULT 'simple', -- simple, complex, custom
ADD COLUMN computed_mapping_notes TEXT;

-- –°–æ–∑–¥–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞
ALTER TABLE mcl.postgres_columns 
ADD CONSTRAINT fk_computed_function_mapping
FOREIGN KEY (computed_function_mapping_rule_id)
REFERENCES mcl.function_mapping_rules(id)
ON DELETE SET NULL
ON UPDATE CASCADE;

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_postgres_columns_computed_mapping ON mcl.postgres_columns(computed_function_mapping_rule_id);
CREATE INDEX idx_postgres_columns_computed_status ON mcl.postgres_columns(computed_mapping_status);
```

#### **3. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã postgres_default_constraints**

```sql
-- –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã postgres_default_constraints –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞
ALTER TABLE mcl.postgres_default_constraints
ADD COLUMN function_mapping_rule_id INTEGER,
ADD COLUMN mapping_status VARCHAR DEFAULT 'pending', -- pending, mapped, error
ADD COLUMN mapping_complexity VARCHAR DEFAULT 'simple', -- simple, complex, custom
ADD COLUMN mapping_notes TEXT;

-- –°–æ–∑–¥–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞
ALTER TABLE mcl.postgres_default_constraints 
ADD CONSTRAINT fk_default_function_mapping
FOREIGN KEY (function_mapping_rule_id)
REFERENCES mcl.function_mapping_rules(id)
ON DELETE SET NULL
ON UPDATE CASCADE;

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_postgres_default_constraints_mapping ON mcl.postgres_default_constraints(function_mapping_rule_id);
CREATE INDEX idx_postgres_default_constraints_status ON mcl.postgres_default_constraints(mapping_status);
```

---

## üîß –ê–õ–ì–û–†–ò–¢–ú –ú–ê–ü–ü–ò–ù–ì–ê –§–£–ù–ö–¶–ò–ô

### **–≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞**

```python
def create_basic_function_mapping_rules() -> bool:
    """
    –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞ —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º
    """
    cursor.execute('''
        INSERT INTO mcl.function_mapping_rules 
        (source_function, target_function, mapping_pattern, replacement_pattern, mapping_type, complexity_level, applicable_objects, description) 
        VALUES
        -- –ü—Ä–æ—Å—Ç—ã–µ –∑–∞–º–µ–Ω—ã (–ø—Ä–∏–º–µ–Ω–∏–º—ã –∫–æ –≤—Å–µ–º —Ç–∏–ø–∞–º –æ–±—ä–µ–∫—Ç–æ–≤)
        ('getdate', 'NOW', 'getdate\\s*\\(\\s*\\)', 'NOW()', 'direct', 1, 
         ARRAY['default_constraint', 'computed_column', 'check_constraint'], 
         '–ó–∞–º–µ–Ω–∞ getdate() –Ω–∞ NOW()'),
        
        ('isnull', 'COALESCE', 'isnull\\s*\\(\\s*([^,]+)\\s*,\\s*([^)]+)\\s*\\)', 'COALESCE(\\1, \\2)', 'regex', 1,
         ARRAY['default_constraint', 'computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ isnull(expr1, expr2) –Ω–∞ COALESCE(expr1, expr2)'),
        
        ('len', 'LENGTH', 'len\\s*\\(\\s*([^)]+)\\s*\\)', 'LENGTH(\\1)', 'regex', 1,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ len() –Ω–∞ LENGTH()'),
        
        ('upper', 'UPPER', 'upper\\s*\\(\\s*([^)]+)\\s*\\)', 'UPPER(\\1)', 'regex', 1,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ upper() –Ω–∞ UPPER()'),
        
        ('lower', 'LOWER', 'lower\\s*\\(\\s*([^)]+)\\s*\\)', 'LOWER(\\1)', 'regex', 1,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ lower() –Ω–∞ LOWER()'),
        
        -- –°–ª–æ–∂–Ω—ã–µ –∑–∞–º–µ–Ω—ã
        ('substring', 'SUBSTRING', 'substring\\s*\\(\\s*([^,]+)\\s*,\\s*([^,]+)\\s*,\\s*([^)]+)\\s*\\)', 'SUBSTRING(\\1 FROM \\2 FOR \\3)', 'regex', 2,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ substring(str, start, length) –Ω–∞ SUBSTRING(str FROM start FOR length)'),
        
        ('convert', 'CAST', 'convert\\s*\\(\\s*([^,]+)\\s*,\\s*([^)]+)\\s*\\)', 'CAST(\\2 AS \\1)', 'regex', 2,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ convert(datatype, expression) –Ω–∞ CAST(expression AS datatype)'),
        
        -- –§—É–Ω–∫—Ü–∏–∏ –¥–∞—Ç
        ('dateadd', 'DATE_ADD', 'dateadd\\s*\\(\\s*([^,]+)\\s*,\\s*([^,]+)\\s*,\\s*([^)]+)\\s*\\)', '\\3 + INTERVAL \\2 \\1', 'regex', 2,
         ARRAY['computed_column', 'check_constraint'],
         '–ó–∞–º–µ–Ω–∞ dateadd(datepart, number, date) –Ω–∞ date + INTERVAL number datepart'),
        
        ('datediff', 'DATE_PART', 'datediff\\s*\\(\\s*([^,]+)\\s*,\\s*([^,]+)\\s*,\\s*([^)]+)\\s*\\)', 'DATE_PART(\\1, \\3) - DATE_PART(\\1, \\2)', 'regex', 3,
         ARRAY['computed_column', 'check_constraint'],
         '–ó–∞–º–µ–Ω–∞ datediff(datepart, startdate, enddate) –Ω–∞ DATE_PART(datepart, enddate) - DATE_PART(datepart, startdate)'),
        
        ('year', 'EXTRACT', 'year\\s*\\(\\s*([^)]+)\\s*\\)', 'EXTRACT(YEAR FROM \\1)', 'regex', 1,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ year(date) –Ω–∞ EXTRACT(YEAR FROM date)'),
        
        ('month', 'EXTRACT', 'month\\s*\\(\\s*([^)]+)\\s*\\)', 'EXTRACT(MONTH FROM \\1)', 'regex', 1,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ month(date) –Ω–∞ EXTRACT(MONTH FROM date)'),
        
        ('day', 'EXTRACT', 'day\\s*\\(\\s*([^)]+)\\s*\\)', 'EXTRACT(DAY FROM \\1)', 'regex', 1,
         ARRAY['computed_column', 'check_constraint', 'index'],
         '–ó–∞–º–µ–Ω–∞ day(date) –Ω–∞ EXTRACT(DAY FROM date)')
    ''')
    
    return True
```

### **–≠—Ç–∞–ø 2: –ê–Ω–∞–ª–∏–∑ –∏ –º–∞–ø–ø–∏–Ω–≥ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π**

```python
def analyze_and_map_computed_columns(task_id: int) -> Dict:
    """
    –ê–Ω–∞–ª–∏–∑ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞
    """
    results = {
        'total_computed_columns': 0,
        'mapped_columns': 0,
        'unmapped_columns': 0,
        'errors': []
    }
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    cursor.execute('''
        SELECT 
            pc.id,
            pc.computed_definition,
            pt.object_name,
            pc.column_name
        FROM mcl.postgres_columns pc
        JOIN mcl.postgres_tables pt ON pc.table_id = pt.id
        JOIN mcl.mssql_tables mt ON pt.source_table_id = mt.id
        WHERE mt.task_id = %s
            AND pc.is_computed = true
            AND pc.computed_definition IS NOT NULL
    ''', (task_id,))
    
    computed_columns = cursor.fetchall()
    results['total_computed_columns'] = len(computed_columns)
    
    for column_id, definition, table_name, column_name in computed_columns:
        try:
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ –º–∞–ø–ø–∏–Ω–≥–∞
            mapped_definition = apply_function_mapping_rules(definition)
            
            if mapped_definition != definition:
                # –ù–∞–π–¥–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞
                rule_id = find_applied_rule_id(definition, mapped_definition)
                
                cursor.execute('''
                    UPDATE mcl.postgres_columns 
                    SET 
                        computed_function_mapping_rule_id = %s,
                        computed_mapping_status = 'mapped',
                        computed_mapping_complexity = (
                            SELECT CASE 
                                WHEN complexity_level = 1 THEN 'simple'
                                WHEN complexity_level = 2 THEN 'complex'
                                ELSE 'custom'
                            END
                            FROM mcl.function_mapping_rules 
                            WHERE id = %s
                        ),
                        postgres_computed_definition = %s
                    WHERE id = %s
                ''', (rule_id, rule_id, mapped_definition, column_id))
                
                results['mapped_columns'] += 1
            else:
                # –§—É–Ω–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
                cursor.execute('''
                    UPDATE mcl.postgres_columns 
                    SET 
                        computed_mapping_status = 'no_functions_found',
                        postgres_computed_definition = %s
                    WHERE id = %s
                ''', (definition, column_id))
                
                results['unmapped_columns'] += 1
                
        except Exception as e:
            # –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞–ø–ø–∏–Ω–≥–µ
            cursor.execute('''
                UPDATE mcl.postgres_columns 
                SET 
                    computed_mapping_status = 'error',
                    computed_mapping_notes = %s
                WHERE id = %s
            ''', (str(e), column_id))
            
            results['errors'].append({
                'column_id': column_id,
                'table_name': table_name,
                'column_name': column_name,
                'error': str(e)
            })
    
    return results

def apply_function_mapping_rules(definition: str) -> str:
    """
    –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞ —Ñ—É–Ω–∫—Ü–∏–π –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—é
    """
    cursor.execute('''
        SELECT 
            mapping_pattern,
            replacement_pattern,
            mapping_type
        FROM mcl.function_mapping_rules
        WHERE is_active = TRUE
            AND 'computed_column' = ANY(applicable_objects)
        ORDER BY complexity_level, source_function
    ''')
    
    rules = cursor.fetchall()
    result = definition
    
    for pattern, replacement, mapping_type in rules:
        if mapping_type == 'direct':
            # –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞
            result = result.replace(pattern.split('\\')[0], replacement.split('\\')[0])
        elif mapping_type == 'regex':
            # –ó–∞–º–µ–Ω–∞ –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é
            import re
            result = re.sub(pattern, replacement, result, flags=re.IGNORECASE)
    
    return result
```

### **–≠—Ç–∞–ø 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π**

```python
def validate_and_create_views(task_id: int) -> Dict:
    """
    –í–∞–ª–∏–¥–∞—Ü–∏—è –º–∞–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
    """
    results = {
        'views_created': 0,
        'validation_errors': 0,
        'creation_errors': 0,
        'errors': []
    }
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã —Å –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏
    cursor.execute('''
        SELECT 
            pt.object_name as view_name,
            pt.base_table_name,
            COUNT(pc.id) as computed_columns_count
        FROM mcl.postgres_tables pt
        JOIN mcl.mssql_tables mt ON pt.source_table_id = mt.id
        LEFT JOIN mcl.postgres_columns pc ON pt.id = pc.table_id AND pc.is_computed = true
        WHERE mt.task_id = 2 
            AND pt.has_computed_columns = true
        GROUP BY pt.object_name, pt.base_table_name
        ORDER BY pt.object_name
    ''')
    
    tables_with_computed = cursor.fetchall()
    
    for view_name, base_table_name, computed_count in tables_with_computed:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è –∑–∞–º–∞–ø–ø–∏—Ä–æ–≤–∞–Ω—ã
            cursor.execute('''
                SELECT COUNT(*) as unmapped_count
                FROM mcl.postgres_columns pc
                JOIN mcl.postgres_tables pt ON pc.table_id = pt.id
                JOIN mcl.mssql_tables mt ON pt.source_table_id = mt.id
                WHERE mt.task_id = 2
                    AND pt.object_name = %s
                    AND pc.is_computed = true
                    AND pc.computed_mapping_status = 'error'
            ''', (view_name,))
            
            unmapped_count = cursor.fetchone()[0]
            
            if unmapped_count > 0:
                results['validation_errors'] += 1
                results['errors'].append({
                    'view_name': view_name,
                    'error': f'–ï—Å—Ç—å {unmapped_count} –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π'
                })
                continue
            
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
            create_view_sql = build_view_definition(view_name, base_table_name)
            
            cursor.execute(create_view_sql)
            results['views_created'] += 1
            
        except Exception as e:
            results['creation_errors'] += 1
            results['errors'].append({
                'view_name': view_name,
                'error': str(e)
            })
    
    return results

def build_view_definition(view_name: str, base_table_name: str) -> str:
    """
    –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    """
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
    cursor.execute('''
        SELECT 
            pc.column_name,
            pc.is_computed,
            pc.postgres_computed_definition,
            pc.ordinal_position
        FROM mcl.postgres_columns pc
        JOIN mcl.postgres_tables pt ON pc.table_id = pt.id
        WHERE pt.object_name = %s
        AND (pc.target_type = 'both' OR pc.target_type = 'view')
        ORDER BY pc.ordinal_position
    ''', (view_name,))
    
    columns = cursor.fetchall()
    
    select_parts = []
    for col_name, is_computed, computed_def, position in columns:
        if is_computed and computed_def:
            # –í—ã—á–∏—Å–ª—è–µ–º–∞—è –∫–æ–ª–æ–Ω–∫–∞
            select_parts.append(f'    {computed_def} AS "{col_name}"')
        else:
            # –û–±—ã—á–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞
            select_parts.append(f'    "{col_name}"')
    
    select_clause = ',\\n'.join(select_parts)
    
    return f'''CREATE OR REPLACE VIEW ags."{view_name}" AS
SELECT
{select_clause}
FROM ags."{base_table_name}";'''
```

---

## üìä –ü–†–ò–ú–ï–†–´ –ó–ê–ü–†–û–°–û–í –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê –ú–ê–ü–ü–ò–ù–ì–ê

### **üîç –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç—É—Å–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π:**

```sql
-- –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç—É—Å–∞ –º–∞–ø–ø–∏–Ω–≥–∞ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π
SELECT 
    computed_mapping_status,
    COUNT(*) as count,
    ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as percentage
FROM mcl.postgres_columns pc
JOIN mcl.postgres_tables pt ON pc.table_id = pt.id
JOIN mcl.mssql_tables mt ON pt.source_table_id = mt.id
WHERE mt.task_id = 2
    AND pc.is_computed = true
GROUP BY computed_mapping_status
ORDER BY count DESC;
```

### **üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞:**

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞
SELECT 
    fmr.source_function,
    fmr.target_function,
    fmr.complexity_level,
    COUNT(pc.id) as computed_columns_count,
    COUNT(pdc.id) as default_constraints_count,
    (COUNT(pc.id) + COUNT(pdc.id)) as total_usage
FROM mcl.function_mapping_rules fmr
LEFT JOIN mcl.postgres_columns pc ON fmr.id = pc.computed_function_mapping_rule_id
LEFT JOIN mcl.postgres_default_constraints pdc ON fmr.id = pdc.function_mapping_rule_id
WHERE fmr.is_active = TRUE
GROUP BY fmr.id, fmr.source_function, fmr.target_function, fmr.complexity_level
ORDER BY total_usage DESC;
```

### **üö® –ü–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π:**

```sql
-- –ü–æ–∏—Å–∫ –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π —Å –æ—à–∏–±–∫–∞–º–∏ –º–∞–ø–ø–∏–Ω–≥–∞
SELECT 
    pt.object_name as table_name,
    pc.column_name,
    pc.computed_definition,
    pc.computed_mapping_status,
    pc.computed_mapping_notes
FROM mcl.postgres_columns pc
JOIN mcl.postgres_tables pt ON pc.table_id = pt.id
JOIN mcl.mssql_tables mt ON pt.source_table_id = mt.id
WHERE mt.task_id = 2
    AND pc.is_computed = true
    AND pc.computed_mapping_status = 'error'
ORDER BY pt.object_name, pc.column_name;
```

---

## üöÄ –ü–õ–ê–ù –í–ù–ï–î–†–ï–ù–ò–Ø

### **–≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã (1-2 –¥–Ω—è)**
1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã `function_mapping_rules`
2. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `postgres_columns` —Å –≤–Ω–µ—à–Ω–∏–º –∫–ª—é—á–æ–º
3. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `postgres_default_constraints` —Å –≤–Ω–µ—à–Ω–∏–º –∫–ª—é—á–æ–º
4. –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

### **–≠—Ç–∞–ø 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞ (1 –¥–µ–Ω—å)**
1. –í—Å—Ç–∞–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞
2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö
3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª

### **–≠—Ç–∞–ø 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞ (2-3 –¥–Ω—è)**
1. –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π
2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –º–∞–ø–ø–∏–Ω–≥–∞
3. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫

### **–≠—Ç–∞–ø 4: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (1 –¥–µ–Ω—å)**
1. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
2. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
3. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π

### **–≠—Ç–∞–ø 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 –¥–µ–Ω—å)**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –º–∞–ø–ø–∏–Ω–≥–∞
2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

---

## üéØ –û–ñ–ò–î–ê–ï–ú–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –º–∞–ø–ø–∏–Ω–≥–∞ —Ñ—É–Ω–∫—Ü–∏–π:

1. **32 —Ç–∞–±–ª–∏—Ü—ã —Å –≤—ã—á–∏—Å–ª—è–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏** –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
2. **32 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è** –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
3. **100% –ø–æ–∫—Ä—ã—Ç–∏–µ** –º–∞–ø–ø–∏–Ω–≥–∞ —Ñ—É–Ω–∫—Ü–∏–π
4. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø—Ä–∞–≤–∏–ª–∞–º–∏ –º–∞–ø–ø–∏–Ω–≥–∞
5. **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è** –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
6. **–ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å** –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–æ–≤

---

## üèÜ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–°–∏—Å—Ç–µ–º–∞ –º–∞–ø–ø–∏–Ω–≥–∞ —Ñ—É–Ω–∫—Ü–∏–π —Ä–µ—à–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É –º–∏–≥—Ä–∞—Ü–∏–∏:**

- ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ—à–∏–±–æ–∫** –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è—Ö –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ** –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
- ‚úÖ **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** –ø—Ä–∞–≤–∏–ª–∞–º–∏ –º–∞–ø–ø–∏–Ω–≥–∞
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
- ‚úÖ **–ü–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç—å** –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–∞–ø–ø–∏–Ω–≥–∞

**–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –≤—ã—á–∏—Å–ª—è–µ–º—ã—Ö –ø–æ–ª–µ–π.**
