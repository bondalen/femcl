# ПРАВИЛА МОНИТОРИНГА И ОТЧЁТНОСТИ МИГРАЦИИ

## Описание
Данный модуль обеспечивает мониторинг прогресса миграции в реальном времени, генерацию детальных отчётов, создание дашбордов с метриками и уведомления о критических событиях.

## Основные функции

### 1. Мониторинг в реальном времени
- Отслеживание статуса каждой таблицы
- Мониторинг производительности миграции
- Контроль использования ресурсов
- Отслеживание ошибок и предупреждений

### 2. Генерация отчётов
- Детальные отчёты по прогрессу миграции
- Статистические отчёты по производительности
- Отчёты по ошибкам и их анализу
- Сводные отчёты по завершённым этапам

### 3. Дашборды и визуализация
- Интерактивные дашборды с метриками
- Графики прогресса миграции
- Диаграммы зависимостей
- Временные шкалы выполнения

### 4. Уведомления и алерты
- Уведомления о критических событиях
- Алерты при превышении лимитов
- Уведомления о завершении этапов
- Эскалация при критических ошибках

## Типы мониторинга

### Мониторинг прогресса
- **Общий прогресс** - процент завершённых таблиц
- **Прогресс по этапам** - структура, данные, ключи
- **Временные метрики** - скорость, ETA, задержки
- **Качественные метрики** - успешность, ошибки

### Мониторинг производительности
- **Скорость миграции** - таблиц в час/день
- **Использование ресурсов** - CPU, память, диск
- **Пропускная способность** - записи в секунду
- **Время отклика** - задержки операций

### Мониторинг ошибок
- **Классификация ошибок** - типы и частота
- **Анализ причин** - корневые причины
- **Тренды ошибок** - увеличение/уменьшение
- **Влияние на прогресс** - блокирующие ошибки

### Мониторинг зависимостей
- **Готовность ссылочных таблиц** - процент готовности
- **Блокирующие зависимости** - критические пути
- **Циклические зависимости** - обнаружение циклов
- **Порядок миграции** - оптимальность последовательности

## Python API

### Основные функции

#### `start_monitoring()`
```python
def start_monitoring():
    """
    Запуск мониторинга в реальном времени
    
    Returns:
        bool: True если мониторинг запущен успешно
    """
```

#### `generate_progress_report()`
```python
def generate_progress_report():
    """
    Генерация отчёта о прогрессе миграции
    
    Returns:
        dict: Детальный отчёт о прогрессе
    """
```

#### `create_dashboard()`
```python
def create_dashboard():
    """
    Создание интерактивного дашборда
    
    Returns:
        str: HTML дашборд
    """
```

#### `send_notification(event_type, message, severity)`
```python
def send_notification(event_type, message, severity):
    """
    Отправка уведомления
    
    Args:
        event_type (str): Тип события
        message (str): Текст сообщения
        severity (str): Уровень критичности
    
    Returns:
        bool: True если уведомление отправлено
    """
```

### Дополнительные функции

#### `get_real_time_metrics()`
```python
def get_real_time_metrics():
    """
    Получение метрик в реальном времени
    
    Returns:
        dict: Текущие метрики миграции
    """
```

#### `generate_performance_report()`
```python
def generate_performance_report():
    """
    Генерация отчёта о производительности
    
    Returns:
        dict: Отчёт о производительности
    """
```

#### `generate_error_analysis_report()`
```python
def generate_error_analysis_report():
    """
    Генерация отчёта об анализе ошибок
    
    Returns:
        dict: Отчёт об ошибках
    """
```

#### `export_report(format_type, report_data)`
```python
def export_report(format_type, report_data):
    """
    Экспорт отчёта в различных форматах
    
    Args:
        format_type (str): Формат экспорта (PDF, Excel, CSV)
        report_data (dict): Данные отчёта
    
    Returns:
        str: Путь к экспортированному файлу
    """
```

## Структура данных

### Таблица метрик
```sql
CREATE TABLE mcl.migration_metrics (
    id SERIAL PRIMARY KEY,
    metric_name VARCHAR(100) NOT NULL,
    metric_value DECIMAL(15,4),
    metric_unit VARCHAR(50),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    table_name VARCHAR(255),
    phase VARCHAR(50)
);
```

### Таблица событий
```sql
CREATE TABLE mcl.migration_events (
    id SERIAL PRIMARY KEY,
    event_type VARCHAR(100) NOT NULL,
    event_message TEXT,
    severity VARCHAR(20) DEFAULT 'INFO',
    table_name VARCHAR(255),
    phase VARCHAR(50),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata JSONB
);
```

### Таблица уведомлений
```sql
CREATE TABLE mcl.migration_notifications (
    id SERIAL PRIMARY KEY,
    notification_type VARCHAR(100) NOT NULL,
    title VARCHAR(255),
    message TEXT,
    severity VARCHAR(20),
    status VARCHAR(20) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sent_at TIMESTAMP,
    recipient VARCHAR(255)
);
```

### Индексы
```sql
CREATE INDEX idx_migration_metrics_name_time ON mcl.migration_metrics(metric_name, timestamp);
CREATE INDEX idx_migration_events_type_time ON mcl.migration_events(event_type, timestamp);
CREATE INDEX idx_migration_notifications_status ON mcl.migration_notifications(status);
```

## Типы отчётов

### Отчёты о прогрессе
- **Ежедневный прогресс** - сводка за день
- **Недельный прогресс** - тренды за неделю
- **Месячный прогресс** - долгосрочные тренды
- **Детальный прогресс** - по каждой таблице

### Отчёты о производительности
- **Скорость миграции** - таблиц в час/день
- **Использование ресурсов** - CPU, память, диск
- **Пропускная способность** - записи в секунду
- **Время выполнения** - по этапам и таблицам

### Отчёты об ошибках
- **Сводка ошибок** - общая статистика
- **Детальный анализ** - по типам ошибок
- **Тренды ошибок** - динамика изменений
- **Рекомендации** - предложения по исправлению

### Отчёты о зависимостях
- **Анализ зависимостей** - граф связей
- **Готовность ссылочных таблиц** - статус готовности
- **Критические пути** - блокирующие зависимости
- **Оптимизация порядка** - предложения по улучшению

## Дашборды

### Основной дашборд
- **Общий прогресс** - процент завершения
- **Статус таблиц** - распределение по статусам
- **Скорость миграции** - график скорости
- **Активные ошибки** - текущие проблемы

### Дашборд производительности
- **Использование ресурсов** - CPU, память, диск
- **Пропускная способность** - записи в секунду
- **Время выполнения** - по этапам
- **Оптимизация** - предложения по улучшению

### Дашборд зависимостей
- **Граф зависимостей** - визуализация связей
- **Готовность таблиц** - статус готовности
- **Критические пути** - блокирующие зависимости
- **Порядок миграции** - оптимальная последовательность

### Дашборд ошибок
- **Статистика ошибок** - по типам и частоте
- **Тренды ошибок** - динамика изменений
- **Анализ причин** - корневые причины
- **Рекомендации** - предложения по исправлению

## Уведомления

### Типы уведомлений
- **Информационные** - общий прогресс
- **Предупреждения** - потенциальные проблемы
- **Ошибки** - критические проблемы
- **Критические** - блокирующие проблемы

### Каналы уведомлений
- **Email** - детальные уведомления
- **SMS** - критические события
- **Slack/Teams** - командные уведомления
- **Webhook** - интеграция с внешними системами

### Настройки уведомлений
- **Фильтры** - по типам событий
- **Частота** - интервалы отправки
- **Получатели** - списки адресатов
- **Эскалация** - автоматическое повышение критичности

## Метрики и KPI

### Основные метрики
- **Общий прогресс** - процент завершённых таблиц
- **Скорость миграции** - таблиц в час/день
- **Успешность** - процент успешных миграций
- **Время выполнения** - среднее время миграции

### Метрики производительности
- **Использование CPU** - процент загрузки
- **Использование памяти** - объём памяти
- **Использование диска** - объём дискового пространства
- **Сетевая активность** - трафик данных

### Метрики качества
- **Количество ошибок** - общее число ошибок
- **Время восстановления** - время исправления ошибок
- **Повторные попытки** - количество повторных попыток
- **Успешность валидации** - процент успешных проверок

## Интеграция с другими модулями

### С модулем управления списком таблиц
- Получение статуса таблиц
- Обновление метрик прогресса
- Отслеживание изменений статуса

### С модулем анализа зависимостей
- Мониторинг готовности ссылочных таблиц
- Отслеживание критических зависимостей
- Анализ блокирующих факторов

### С модулем переноса данных
- Мониторинг процесса переноса
- Отслеживание производительности
- Контроль качества данных

## Обработка ошибок

### Типы ошибок
1. **Системные ошибки** - проблемы инфраструктуры
2. **Ошибки данных** - проблемы с данными
3. **Ошибки зависимостей** - проблемы с внешними ключами
4. **Ошибки производительности** - медленный перенос

### Стратегии обработки
1. **Автоматическое восстановление** - для временных ошибок
2. **Повторные попытки** - с экспоненциальной задержкой
3. **Эскалация** - для критических ошибок
4. **Уведомления** - для всех заинтересованных сторон

## Примеры использования

### Запуск мониторинга
```python
# Запуск мониторинга
monitor = MigrationMonitor()
monitor.start_monitoring()

# Получение метрик в реальном времени
metrics = monitor.get_real_time_metrics()
print(f"Прогресс: {metrics['progress_percentage']:.1f}%")
print(f"Скорость: {metrics['migration_speed']:.1f} таблиц/час")
```

### Генерация отчётов
```python
# Генерация отчёта о прогрессе
progress_report = monitor.generate_progress_report()
print(f"Завершено таблиц: {progress_report['completed_tables']}")
print(f"Осталось времени: {progress_report['estimated_remaining_time']}")

# Экспорт отчёта
monitor.export_report('PDF', progress_report)
```

### Создание дашборда
```python
# Создание дашборда
dashboard = monitor.create_dashboard()
with open('migration_dashboard.html', 'w') as f:
    f.write(dashboard)
```

### Отправка уведомлений
```python
# Отправка уведомления о критической ошибке
monitor.send_notification(
    event_type='CRITICAL_ERROR',
    message='Обнаружена критическая ошибка в таблице orders',
    severity='CRITICAL'
)
```

## Следующие шаги

1. **Реализация Python функций**
2. **Создание тестового скрипта**
3. **Интеграция с существующими модулями**
4. **Тестирование на реальных данных**
5. **Настройка уведомлений и алертов**