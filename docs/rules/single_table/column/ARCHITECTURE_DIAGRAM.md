# 🏗️ АРХИТЕКТУРНАЯ ДИАГРАММА ВИДОВОЙ МИГРАЦИИ

## 📊 СХЕМА ПОДХОДА 1: РАСШИРЕНИЕ ТАБЛИЦЫ `postgres_tables`

```
┌─────────────────────────────────────────────────────────────────┐
│                    ИСХОДНАЯ БАЗА ДАННЫХ (MS SQL)               │
├─────────────────────────────────────────────────────────────────┤
│  mssql_tables                                                   │
│  ┌─────────────┬─────────────────────────────────────────────┐  │
│  │ id          │ 1, 2, 3, ...                               │  │
│  │ object_name │ users, orders, products, ...                │  │
│  │ task_id     │ 2                                           │  │
│  └─────────────┴─────────────────────────────────────────────┘  │
│                                                                 │
│  mssql_columns                                                  │
│  ┌─────────────┬─────────────────────────────────────────────┐  │
│  │ id          │ 1, 2, 3, ...                               │  │
│  │ table_id    │ ссылка на mssql_tables                     │  │
│  │ column_name │ id, name, age, full_name, ...              │  │
│  │ is_computed │ false, false, false, true, ...             │  │
│  └─────────────┴─────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ЦЕЛЕВАЯ БАЗА ДАННЫХ (PostgreSQL)             │
├─────────────────────────────────────────────────────────────────┤
│  postgres_tables (РАСШИРЕННАЯ)                                  │
│  ┌─────────────┬─────────────────────────────────────────────┐  │
│  │ id          │ 1, 2, 3, ...                               │  │
│  │ source_table_id │ ссылка на mssql_tables                │  │
│  │ object_name │ users, orders, products, ...                │  │
│  │ base_table_name │ users_bt, orders, products_bt, ...     │  │
│  │ view_name   │ users, orders, products, ...                │  │
│  │ has_computed_columns │ true, false, true, ...            │  │
│  └─────────────┴─────────────────────────────────────────────┘  │
│                                                                 │
│  postgres_columns (РАСШИРЕННАЯ)                                 │
│  ┌─────────────┬─────────────────────────────────────────────┐  │
│  │ id          │ 1, 2, 3, ...                               │  │
│  │ table_id    │ ссылка на postgres_tables                  │  │
│  │ source_column_id │ ссылка на mssql_columns              │  │
│  │ column_name │ id, name, age, full_name, ...              │  │
│  │ is_computed │ false, false, false, true, ...             │  │
│  │ target_type │ base_table, base_table, base_table, view   │  │
│  └─────────────┴─────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ФИЗИЧЕСКИЕ ОБЪЕКТЫ PostgreSQL               │
├─────────────────────────────────────────────────────────────────┤
│  ФИЗИЧЕСКИЕ ТАБЛИЦЫ                                             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ users_bt (только физические колонки)                       │ │
│  │ ┌─────────┬─────────┬─────────┐                           │ │
│  │ │ id      │ name    │ age     │                           │ │
│  │ └─────────┴─────────┴─────────┘                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  orders (обычная таблица без вычисляемых полей)                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ ┌─────────┬─────────┬─────────┐                           │ │
│  │ │ id      │ user_id │ amount  │                           │ │
│  │ └─────────┴─────────┴─────────┘                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ПРЕДСТАВЛЕНИЯ                                                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ users (включает все колонки + вычисляемые)                  │ │
│  │ ┌─────────┬─────────┬─────────┬─────────────┐             │ │
│  │ │ id      │ name    │ age     │ full_name   │             │ │
│  │ └─────────┴─────────┴─────────┴─────────────┘             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  orders (представление = таблица, так как нет вычисляемых полей) │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │ ┌─────────┬─────────┬─────────┐                           │ │
│  │ │ id      │ user_id │ amount  │                           │ │
│  │ └─────────┴─────────┴─────────┘                           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 ЛОГИКА РАБОТЫ

### **Пример 1: Таблица с вычисляемыми полями (users)**
```
Исходная таблица: users
├── Физические колонки: id, name, age
└── Вычисляемые колонки: full_name (CONCAT(name, ' ', surname))

Результат миграции:
├── Базовая таблица: users_bt
│   └── Колонки: id, name, age
└── Представление: users
    └── Колонки: id, name, age, full_name (вычисляемая)
```

### **Пример 2: Таблица без вычисляемых полей (orders)**
```
Исходная таблица: orders
└── Только физические колонки: id, user_id, amount

Результат миграции:
└── Обычная таблица: orders (без представления)
    └── Колонки: id, user_id, amount
```

## 📋 ПРЕИМУЩЕСТВА ПОДХОДА

### **1. Совместимость приложений:**
```sql
-- Приложение продолжает работать без изменений
SELECT * FROM users WHERE age > 18;  -- Обращается к представлению users

-- Администратор может работать с физическими данными
SELECT * FROM users_bt;  -- Только физические колонки
```

### **2. Производительность:**
- Физические таблицы содержат только реальные данные
- Вычисляемые поля вычисляются только при обращении к представлению
- Индексы создаются только на физических колонках

### **3. Гибкость:**
- Легко добавлять новые вычисляемые поля
- Можно изменять логику вычислений без пересоздания таблиц
- Поддержка любых типов вычисляемых полей

## 🎯 РЕЗУЛЬТАТ

Этот подход обеспечивает:
- **100% совместимость** с существующими приложениями
- **Оптимальную производительность** для физических данных
- **Максимальную гибкость** для вычисляемых полей
- **Простое администрирование** и мониторинг