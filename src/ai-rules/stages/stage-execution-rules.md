# Правила выполнения стадий миграции

## Общие принципы

### Загрузка структуры стадий
- **Источник**: `docs/project/project-docs.json` → `project.architecture.stages.rootStages`
- **Метод**: Парсинг JSON структуры с поддержкой бесконечной вложенности `substages`
- **Валидация**: Проверка корректности структуры и обязательных полей

### Соблюдение порядка выполнения
- **Правило**: Строгое соблюдение `predecessors` из атрибутов стадии
- **Алгоритм**: Построение графа зависимостей и топологическая сортировка
- **Проверка**: Валидация готовности всех предшествующих стадий

### Валидация результатов
- **Критерии**: Использование `validationCriteria` из атрибутов стадии
- **Логирование**: Обязательное сохранение результатов в `mcl.migration_log`
- **Обработка ошибок**: Детальное описание причин неудачи с предложениями по исправлению

## Алгоритм выполнения стадий

### 1. Инициализация
```python
# Псевдокод алгоритма
def initialize_stages():
    stages = load_from_project_docs()
    dependency_graph = build_dependency_graph(stages)
    ready_stages = find_ready_stages(dependency_graph)
    return stages, dependency_graph, ready_stages
```

### 2. Выполнение стадии
```python
def execute_stage(stage_id, stage_data):
    # Начало выполнения
    log_stage_start(stage_id)
    
    # Выполнение операций стадии
    result = perform_stage_operations(stage_data)
    
    # Валидация результатов
    validation_result = validate_stage_results(result, stage_data.validationCriteria)
    
    # Логирование результатов
    log_stage_completion(stage_id, result, validation_result)
    
    return result, validation_result
```

### 3. Обработка ошибок
```python
def handle_stage_error(stage_id, error, context):
    # Логирование ошибки
    log_error(stage_id, error, context)
    
    # Определение типа ошибки
    if is_critical_error(error):
        stop_migration()
        notify_critical_error(error)
    else:
        suggest_recovery_options(error)
        continue_with_monitoring()
```

## Типы стадий и их правила

### Подготовительные стадии (preparation)
- **Цель**: Подготовка к миграции
- **Операции**: Проверка подключений, валидация конфигурации
- **Валидация**: Все подключения успешны, конфигурация корректна
- **Примеры**: 01.01, 01.02

### Стадии миграции (migration)
- **Цель**: Перенос данных и структуры
- **Операции**: Анализ зависимостей, создание объектов, перенос данных
- **Валидация**: Все объекты созданы, данные перенесены без потерь
- **Примеры**: 02.01, 02.02, 02.02.01, 02.02.02

### Стадии валидации (validation)
- **Цель**: Проверка результатов миграции
- **Операции**: Тестирование, проверка целостности, валидация производительности
- **Валидация**: Все критерии успеха выполнены
- **Примеры**: 04.01, 04.02, 04.03

## Мониторинг и логирование

### Отслеживание статуса
- **Состояния**: pending, in-progress, completed, failed, skipped
- **Переходы**: Логирование всех изменений статуса
- **Персистентность**: Сохранение в `mcl.migration_log`

### Сбор метрик
- **Время выполнения**: start_time, end_time для каждой стадии
- **Результаты валидации**: Детальные результаты проверок
- **Ошибки**: Полная информация об ошибках и исключениях

### Уведомления
- **Критические ошибки**: Немедленное уведомление и остановка
- **Предупреждения**: Логирование с продолжением мониторинга
- **Успешное завершение**: Отчет о результатах

## Интеграция с существующими правилами

### Использование DBHub
- **Мониторинг БД**: Отслеживание состояния таблиц и объектов
- **Выполнение SQL**: Создание и валидация объектов БД
- **Анализ данных**: Проверка целостности и качества

### Использование Desktop Commander
- **Логирование**: Запись результатов в файлы
- **Мониторинг**: Отслеживание системных ресурсов
- **Отчеты**: Генерация детальных отчетов

## Обработка исключительных ситуаций

### Критические ошибки
- **Потеря данных**: Немедленная остановка и уведомление
- **Недоступность ресурсов**: Попытка восстановления, затем остановка
- **Ошибки структуры БД**: Детальный анализ и предложения по исправлению

### Некритические ошибки
- **Предупреждения валидации**: Логирование с продолжением
- **Медленное выполнение**: Мониторинг с уведомлениями
- **Нестандартные ситуации**: Анализ и адаптация процесса

---

**Создан**: 2025-10-06  
**Версия**: 1.0.0  
**Автор**: Александр